<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subulus Salaam Academy | Unified Admin Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Global Typography & Reset */
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        /* Animation & Transitions */
        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hidden-view {
            display: none !important;
        }

        /* Sidebar Active States */
        .active-nav {
            background-color: #064e3b !important;
            color: #ffffff !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Login Background */
        .admin-bg {
            background-color: #022c22;
            background-image:
                radial-gradient(at 0% 0%, hsla(158, 82%, 15%, 1) 0, transparent 50%),
                radial-gradient(at 100% 100%, hsla(158, 82%, 15%, 1) 0, transparent 50%);
        }

        .pattern-overlay {
            background-image: url("https://www.transparenttextures.com/patterns/arabesque.png");
            opacity: 0.1;
        }

        /* Professional Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #059669;
            border-radius: 10px;
            border: 2px solid #f1f5f9;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #047857;
        }

        /* Glassmorphism for Overlay */
        .glass-overlay {
            backdrop-filter: blur(8px);
            background-color: rgba(6, 78, 59, 0.4);
        }

        /* Modal Specifics for Mobile */
        .modal-body-scroll {
            max-height: 60vh;
            overflow-y: auto;
        }

        .disabled-input {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f1f5f9;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden font-sans antialiased">

    <div id="custom-alert"
        class="fixed inset-0 z-[200] flex items-center justify-center px-4 pointer-events-none opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div
            class="bg-white rounded-[2rem] shadow-2xl p-8 max-w-sm w-full transform scale-95 transition-all duration-300 relative z-10 text-center border-4 border-white/50">
            <div id="alert-icon-bg"
                class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600 shadow-inner">
                <i id="alert-icon" data-lucide="check-circle" class="w-10 h-10"></i></div>
            <h3 id="alert-title" class="text-2xl font-bold text-slate-800 mb-2 font-serif">Success</h3>
            <p id="alert-message" class="text-slate-500 text-sm font-medium mb-8 leading-relaxed">Operation completed.
            </p>
            <div class="flex gap-4">
                <button id="alert-cancel-btn" onclick="closeAlert()"
                    class="hidden flex-1 py-4 border-2 border-slate-100 text-slate-400 rounded-2xl font-bold hover:bg-slate-50 transition active:scale-95">Cancel</button>
                <button id="alert-ok-btn" onclick="closeAlert()"
                    class="flex-1 py-4 bg-emerald-900 text-white rounded-2xl font-bold shadow-xl shadow-emerald-900/20 hover:bg-emerald-800 hover:-translate-y-1 transition-all active:scale-95">Acknowledge</button>
            </div>
        </div>
    </div>

    <div id="auth-container"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 admin-bg transition-all duration-700">
        <a href="index.html"
            class="absolute top-6 left-6 z-[120] flex items-center gap-3 text-white/80 hover:text-white transition-colors group">
            <div
                class="p-2.5 bg-white/10 rounded-full backdrop-blur-md border border-white/10 group-hover:bg-white/20 transition-all shadow-lg">
                <i data-lucide="arrow-left" class="w-5 h-5"></i></div>
            <span
                class="text-sm font-bold tracking-wider uppercase opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0 duration-300">Return
                Home</span>
        </a>
        <div
            class="w-full max-w-5xl bg-white rounded-[2rem] shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[600px] border border-white/10 relative z-10">
            <div
                class="hidden md:flex w-1/2 bg-emerald-900 relative flex-col justify-between p-12 text-white overflow-hidden">
                <div class="absolute inset-0 pattern-overlay"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-10 h-10 bg-amber-400 rounded-lg flex items-center justify-center text-emerald-900 shadow-lg shadow-amber-400/20">
                            <i data-lucide="shield" class="w-6 h-6"></i></div><span
                            class="text-amber-400 font-bold tracking-widest uppercase text-xs">Secure Gateway</span>
                    </div>
                    <h1 class="text-5xl font-bold font-serif leading-tight mt-6">Subulus Salaam<br><span
                            class="text-emerald-300">Academy</span></h1>
                    <p class="mt-6 text-emerald-100/80 text-lg leading-relaxed font-light">Centralized administration
                        system for teacher oversight, student enrollment, and academic progress tracking.</p>
                </div>
            </div>
            <div class="w-full md:w-1/2 bg-white p-8 md:p-12 flex flex-col justify-center relative">
                <div class="max-w-sm mx-auto w-full">
                    <div class="mb-10 hidden md:block">
                        <h2 class="text-3xl font-bold text-slate-800">Admin Sign In</h2>
                        <p class="text-slate-400 mt-2 text-sm">Enter your master credentials.</p>
                    </div>
                    <form id="adminLoginForm" onsubmit="handleAdminLogin(event)" class="space-y-6">
                        <div class="space-y-2"><label
                                class="text-xs font-bold text-slate-500 uppercase tracking-wide">Email
                                Identifier</label>
                            <div class="relative group"><span
                                    class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-300 group-focus-within:text-emerald-600 transition-colors"><i
                                        data-lucide="mail" class="w-5 h-5"></i></span><input type="email"
                                    id="login-email"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pl-12 pr-4 text-sm font-semibold text-slate-700 outline-none focus:bg-white focus:border-emerald-600 focus:ring-1 focus:ring-emerald-600 transition-all placeholder:text-slate-300"
                                    placeholder="admin1@hayi.com" required></div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between"><label
                                    class="text-xs font-bold text-slate-500 uppercase tracking-wide">Passkey</label>
                            </div>
                            <div class="relative group"><span
                                    class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-300 group-focus-within:text-emerald-600 transition-colors"><i
                                        data-lucide="lock" class="w-5 h-5"></i></span><input type="password"
                                    id="login-password"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pl-12 pr-4 text-sm font-semibold text-slate-700 outline-none focus:bg-white focus:border-emerald-600 focus:ring-1 focus:ring-emerald-600 transition-all placeholder:text-slate-300"
                                    placeholder="••••••••" required></div>
                        </div>
                        <button type="submit" id="loginBtn"
                            class="w-full bg-emerald-900 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-900/20 hover:bg-emerald-800 hover:shadow-xl hover:-translate-y-0.5 transition-all active:scale-95 flex items-center justify-center gap-3 mt-4 group"><span>Authenticate</span><i
                                data-lucide="arrow-right"
                                class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden-view flex h-screen w-full transition-opacity duration-700">
        <div id="mobile-overlay" onclick="toggleSidebar()"
            class="fixed inset-0 z-20 glass-overlay hidden transition-opacity opacity-0 md:hidden"></div>

        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-30 w-80 bg-emerald-950 text-white transform -translate-x-full md:translate-x-0 md:relative sidebar-transition flex flex-col h-full shadow-2xl md:shadow-none border-r border-emerald-900">
            <div class="h-28 flex items-center justify-between px-8 border-b border-emerald-900 bg-emerald-950">
                <div class="flex flex-col"><span
                        class="text-3xl font-bold tracking-tighter text-white uppercase leading-none">An-Noor</span>
                    <div class="flex items-center gap-2 mt-2"><span
                            class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span><span
                            class="text-[10px] text-emerald-400 font-black uppercase tracking-[0.3em]">Admin
                            Portal</span></div>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-emerald-300 hover:text-white transition"><i
                        data-lucide="x-circle" class="w-8 h-8"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-10 px-6">
                <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest mb-4 px-2">Main Menu</p>
                <ul class="space-y-4">
                    <li><button onclick="switchView('dashboard')" id="nav-dashboard"
                            class="nav-btn w-full flex items-center px-6 py-5 active-nav rounded-2xl transition-all duration-300 group"><i
                                data-lucide="layout-dashboard"
                                class="w-5 h-5 mr-4 group-hover:rotate-6 transition-transform"></i><span
                                class="font-bold tracking-wide text-sm">System Overview</span></button></li>
                    <li><button onclick="switchView('teachers')" id="nav-teachers"
                            class="nav-btn w-full flex items-center px-6 py-5 text-emerald-100 hover:bg-emerald-900/50 rounded-2xl transition-all duration-300 group border border-transparent hover:border-emerald-800"><i
                                data-lucide="users"
                                class="w-5 h-5 mr-4 group-hover:rotate-6 transition-transform"></i><span
                                class="font-bold tracking-wide text-sm">Manage Teachers</span></button></li>
                    <li><button onclick="switchView('students')" id="nav-students"
                            class="nav-btn w-full flex items-center px-6 py-5 text-emerald-100 hover:bg-emerald-900/50 rounded-2xl transition-all duration-300 group border border-transparent hover:border-emerald-800"><i
                                data-lucide="graduation-cap"
                                class="w-5 h-5 mr-4 group-hover:rotate-6 transition-transform"></i><span
                                class="font-bold tracking-wide text-sm">Manage Students</span></button></li>
                    <li><button onclick="switchView('news')" id="nav-news"
                            class="nav-btn w-full flex items-center px-6 py-5 text-emerald-100 hover:bg-emerald-900/50 rounded-2xl transition-all duration-300 group border border-transparent hover:border-emerald-800"><i
                                data-lucide="newspaper"
                                class="w-5 h-5 mr-4 group-hover:rotate-6 transition-transform"></i><span
                                class="font-bold tracking-wide text-sm">News & Media</span></button></li>
                </ul>
            </nav>
            <div class="p-8 border-t border-emerald-900 bg-emerald-950"><button onclick="handleLogout()"
                    class="flex items-center justify-center w-full py-4 bg-emerald-900/30 text-emerald-400 rounded-2xl hover:text-white hover:bg-rose-900/80 transition-all text-xs font-black border border-emerald-800/50 uppercase tracking-widest group"><i
                        data-lucide="log-out" class="w-4 h-4 mr-3 group-hover:-translate-x-1 transition-transform"></i>
                    Terminate Session</button></div>
        </aside>

        <div class="flex-1 flex flex-col h-screen w-full relative overflow-hidden bg-slate-50">
            <header
                class="h-24 bg-white border-b border-slate-200 flex items-center justify-between px-8 sm:px-12 z-10 sticky top-0 shadow-sm/50">
                <div class="flex items-center"><button onclick="toggleSidebar()"
                        class="md:hidden text-slate-500 hover:text-emerald-700 p-3 rounded-xl hover:bg-slate-100 transition mr-6"><i
                            data-lucide="menu" class="w-7 h-7"></i></button>
                    <div class="hidden sm:block">
                        <h2 class="text-slate-900 font-black text-xl uppercase tracking-tight">Management Console</h2>
                        <div
                            class="flex items-center text-[10px] text-emerald-600 font-bold uppercase tracking-widest mt-1">
                            Current Session: <span id="current-date" class="ml-1 text-slate-500">Loading...</span></div>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-black text-slate-800 leading-tight">Sheikh Principal</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter mt-0.5">Role: Superuser
                        </p>
                    </div>
                    <div
                        class="w-14 h-14 bg-emerald-50 border-2 border-emerald-100 rounded-2xl flex items-center justify-center text-emerald-700 font-black shadow-lg shadow-emerald-100 text-lg">
                        AD</div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-10 scroll-smooth">

                <div id="view-dashboard" class="view-section">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-slate-900 tracking-tight">System Status</h2>
                        <p class="text-slate-500 mt-2 text-sm md:text-lg font-medium">Live overview of operations.</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div
                            class="bg-white p-8 rounded-[2rem] shadow-lg border border-slate-100 flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Students</p>
                                <h3 id="stat-students" class="text-5xl font-black text-emerald-900 mt-2">--</h3>
                            </div>
                            <div class="p-4 bg-emerald-50 text-emerald-600 rounded-2xl"><i data-lucide="users"
                                    class="w-8 h-8"></i></div>
                        </div>
                        <div
                            class="bg-white p-8 rounded-[2rem] shadow-lg border border-slate-100 flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Teachers</p>
                                <h3 id="stat-teachers" class="text-5xl font-black text-emerald-900 mt-2">--</h3>
                            </div>
                            <div class="p-4 bg-blue-50 text-blue-600 rounded-2xl"><i data-lucide="shield-check"
                                    class="w-8 h-8"></i></div>
                        </div>
                        <div
                            class="bg-white p-8 rounded-[2rem] shadow-lg border border-slate-100 flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Posts</p>
                                <h3 id="stat-posts" class="text-5xl font-black text-emerald-900 mt-2">--</h3>
                            </div>
                            <div class="p-4 bg-purple-50 text-purple-600 rounded-2xl"><i data-lucide="megaphone"
                                    class="w-8 h-8"></i></div>
                        </div>
                    </div>
                </div>

                <div id="view-teachers" class="view-section hidden-view">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Teachers Directory</h2>
                            <p class="text-slate-500 mt-1 text-sm md:text-lg font-medium">Control teacher credentials.
                            </p>
                        </div>
                        <button onclick="openModal('add-teacher-modal')"
                            class="w-full md:w-auto bg-emerald-800 text-white px-6 py-3 rounded-xl text-xs font-bold uppercase tracking-widest flex items-center justify-center shadow-2xl hover:bg-emerald-900 transition-all"><i
                                data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Teacher</button>
                    </div>
                    <div class="bg-white rounded-[2rem] shadow-xl border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead
                                    class="bg-slate-50/80 border-b border-slate-200 text-slate-800 font-black uppercase text-[10px] tracking-[0.25em]">
                                    <tr>
                                        <th class="p-6">Teacher Name</th>
                                        <th class="p-6">Access</th>
                                        <th class="p-6">Assignment</th>
                                        <th class="p-6 text-right">Control</th>
                                    </tr>
                                </thead>
                                <tbody id="teachers-table-body" class="divide-y divide-slate-100 text-slate-600">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-students" class="view-section hidden-view">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Active Enrollment</h2>
                            <p class="text-slate-500 mt-1 text-sm md:text-lg font-medium">Manage records.</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                            <button onclick="openTrashModal()"
                                class="bg-rose-100 text-rose-800 border border-rose-200 px-5 py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-rose-200 transition-all flex items-center justify-center"><i
                                    data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Trash Bin</button>
                            <button onclick="releaseAllResults()"
                                class="bg-amber-100 text-amber-800 border border-amber-200 px-5 py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-amber-200 transition-all flex items-center justify-center"><i
                                    data-lucide="check-square" class="w-4 h-4 mr-2"></i> Release All</button>
                            <button onclick="openModal('add-student-modal')"
                                class="bg-emerald-800 text-white px-5 py-3 rounded-xl text-xs font-bold uppercase tracking-widest flex items-center justify-center shadow-2xl hover:bg-emerald-900 transition-all"><i
                                    data-lucide="user-plus" class="w-4 h-4 mr-2"></i> Enroll</button>
                        </div>
                    </div>
                    <div class="relative mb-8"><span
                            class="absolute inset-y-0 left-0 pl-6 flex items-center text-slate-400"><i
                                data-lucide="search" class="w-5 h-5"></i></span><input type="text" id="student-search"
                            onkeyup="filterStudents()"
                            class="w-full bg-white border border-slate-200 rounded-2xl py-4 pl-14 pr-6 text-sm font-semibold outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                            placeholder="Search student..."></div>
                    <div id="students-container" class="space-y-8">
                        <div class="text-center py-20 text-slate-400 italic">Loading Class Lists...</div>
                    </div>
                </div>

                <div id="view-news" class="view-section hidden-view">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-900 tracking-tight">News Feed</h2>
                            <p class="text-slate-500 mt-1 text-sm md:text-lg font-medium">Broadcast media.</p>
                        </div>
                        <button onclick="openModal('add-post-modal')"
                            class="w-full md:w-auto bg-emerald-800 text-white px-8 py-3 rounded-xl text-xs font-bold uppercase tracking-widest flex items-center justify-center shadow-2xl hover:bg-emerald-900 transition-all"><i
                                data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Create</button>
                    </div>
                    <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full text-center py-20 text-slate-400 italic">Loading Feed...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="manage-student-modal"
        class="fixed inset-0 z-[120] glass-overlay hidden flex items-center justify-center p-2 md:p-4">
        <div
            class="bg-white w-[95%] md:w-full max-w-4xl rounded-[2rem] md:rounded-[3rem] shadow-2xl overflow-hidden transform transition-all duration-300 scale-100 border border-white/50 flex flex-col max-h-[90vh]">
            <div class="bg-slate-900 p-6 md:p-8 flex justify-between items-start text-white shrink-0">
                <div class="flex items-center gap-4 md:gap-6">
                    <div
                        class="w-14 h-14 md:w-20 md:h-20 bg-emerald-500 rounded-2xl flex items-center justify-center text-xl md:text-3xl font-black shadow-lg">
                        <span id="manage-student-initials">S</span></div>
                    <div>
                        <h3 id="manage-student-name"
                            class="font-bold text-xl md:text-3xl truncate max-w-[150px] md:max-w-none">Student</h3>
                        <p id="manage-student-id"
                            class="text-emerald-300 text-[10px] md:text-xs font-mono mt-1 uppercase">ID: ...</p>
                        <div class="flex gap-2 mt-2 md:mt-3">
                            <span id="manage-student-grade"
                                class="bg-slate-800 px-2 py-1 md:px-3 md:py-1 rounded-lg text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-slate-300">Class</span>
                            <span id="manage-student-status"
                                class="bg-emerald-900/50 border border-emerald-500/30 px-2 py-1 md:px-3 md:py-1 rounded-lg text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-emerald-400">Active</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeModal('manage-student-modal')"
                    class="bg-white/10 p-2 rounded-full hover:bg-white/20"><i data-lucide="x"
                        class="w-5 h-5 md:w-6 md:h-6"></i></button>
            </div>

            <div class="p-4 md:p-8 overflow-y-auto flex-1 custom-scrollbar space-y-6">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-6">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <p class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">
                            Attendance</p>
                        <h4 id="manage-attendance-pct" class="text-2xl md:text-4xl font-black text-emerald-700">--%</h4>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <p class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Status
                        </p>
                        <h4 id="manage-result-status"
                            class="text-sm md:text-lg font-black text-slate-700 flex items-center gap-1 md:gap-2"><span
                                class="w-2 h-2 md:w-3 md:h-3 rounded-full bg-amber-400"></span> Pending</h4>
                    </div>
                    <div
                        class="col-span-2 md:col-span-1 bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col justify-center">
                        <button onclick="promptPromotion()"
                            class="w-full bg-slate-900 text-white py-2 md:py-3 rounded-xl font-bold text-[10px] md:text-xs uppercase tracking-widest hover:bg-emerald-700 shadow-lg">Promote
                            / Repeat</button></div>
                </div>
                <div>
                    <h4 class="text-lg md:text-xl font-bold text-slate-800 mb-3 border-l-4 border-emerald-500 pl-3">
                        Academic Performance</h4>
                    <div class="border rounded-2xl overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead
                                    class="bg-slate-50 border-b text-slate-500 font-bold uppercase text-[10px] tracking-widest">
                                    <tr>
                                        <th class="p-3 md:p-4">Subject</th>
                                        <th class="p-3 md:p-4 text-center">CA</th>
                                        <th class="p-3 md:p-4 text-center">Exam</th>
                                        <th class="p-3 md:p-4 text-center">Total</th>
                                        <th class="p-3 md:p-4 text-center">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="grades-table-body" class="divide-y text-slate-700 font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 md:p-6 border-t bg-slate-50 flex justify-between items-center shrink-0">
                <span
                    class="text-[10px] md:text-xs text-slate-400 font-bold uppercase tracking-widest hidden md:inline">Action
                    Zone</span>
                <button id="release-result-btn" onclick="toggleResultRelease()"
                    class="w-full md:w-auto bg-emerald-700 text-white px-6 py-3 rounded-2xl font-bold uppercase text-[10px] md:text-xs tracking-widest shadow-xl hover:bg-emerald-800 transition transform active:scale-95 flex items-center justify-center"><i
                        data-lucide="send" class="w-4 h-4 mr-2"></i> Release Result</button>
            </div>
        </div>
    </div>

    <div id="trash-modal" class="fixed inset-0 z-[130] glass-overlay hidden flex items-center justify-center p-4">
        <div
            class="bg-white w-[95%] md:w-full max-w-3xl rounded-[2rem] md:rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-rose-900 p-6 flex justify-between items-center text-white shrink-0">
                <div>
                    <h3 class="font-bold text-xl md:text-2xl">Recycle Bin</h3>
                    <p class="text-[10px] text-rose-300 uppercase mt-1 tracking-widest font-black">Deleted Students</p>
                </div><button onclick="closeModal('trash-modal')"
                    class="bg-white/10 p-2 rounded-full hover:bg-white/20"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>
            <div class="p-0 overflow-y-auto flex-1 bg-slate-50">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-white border-b text-slate-500 font-bold uppercase text-[10px] tracking-widest">
                            <tr>
                                <th class="p-6">Name</th>
                                <th class="p-6">Class</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trash-table-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="add-teacher-modal" class="fixed inset-0 z-[110] glass-overlay hidden flex items-center justify-center p-4">
        <div
            class="bg-white w-[95%] md:w-full max-w-xl mx-auto rounded-[2rem] md:rounded-[3rem] shadow-2xl overflow-hidden transform transition-all duration-300 scale-100 border border-white/50 flex flex-col max-h-[85vh]">
            <div class="bg-emerald-900 p-6 md:p-10 flex justify-between items-center text-white shrink-0">
                <div>
                    <h3 class="font-bold text-2xl md:text-3xl">Add Teacher</h3>
                </div><button onclick="closeModal('add-teacher-modal')"
                    class="bg-white/10 p-2 rounded-full hover:bg-white/20"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>
            <form id="add-teacher-form" class="p-6 md:p-10 overflow-y-auto flex-1 custom-scrollbar space-y-4">
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Name</label><input
                        type="text" id="teacher-name" class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm"
                        required></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Email</label><input
                            type="email" id="teacher-email"
                            class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm" required></div>
                    <div><label
                            class="block text-[11px] font-black text-slate-400 uppercase mb-2">Password</label><input
                            type="password" id="teacher-password"
                            class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm" required></div>
                </div>
                <div class="pt-2 border-t border-slate-100"><label
                        class="block text-[11px] font-black text-emerald-800 uppercase mb-2 text-center">Role</label>
                    <div class="flex bg-slate-100 p-1 rounded-xl mb-4"><label class="flex-1 cursor-pointer"><input
                                type="radio" name="access_type" value="class" class="hidden" checked
                                onchange="toggleTeacherForm('class')">
                            <div
                                class="text-center py-2 text-xs font-black rounded-lg text-slate-400 bg-white shadow-sm">
                                Class</div>
                        </label><label class="flex-1 cursor-pointer"><input type="radio" name="access_type"
                                value="subject" class="hidden" onchange="toggleTeacherForm('subject')">
                            <div class="text-center py-2 text-xs font-black rounded-lg text-slate-400">Subject</div>
                        </label></div>
                    <div id="teacher-dynamic-inputs" class="space-y-3"></div>
                </div>
            </form>
            <div class="p-6 border-t bg-slate-50 shrink-0"><button type="submit" form="add-teacher-form"
                    id="submit-teacher-btn"
                    class="w-full py-3 bg-emerald-800 text-white rounded-xl font-bold uppercase text-xs">Create
                    Account</button></div>
        </div>
    </div>

    <div id="add-student-modal" class="fixed inset-0 z-[110] glass-overlay hidden flex items-center justify-center p-4">
        <div
            class="bg-white w-[95%] md:w-full max-w-2xl rounded-[2rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-emerald-900 p-6 flex justify-between items-center text-white shrink-0">
                <div>
                    <h3 class="font-bold text-xl md:text-2xl">Register Student</h3>
                </div><button onclick="closeModal('add-student-modal')"
                    class="bg-white/10 p-2 rounded-full hover:bg-white/20"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>
            <form id="add-student-form" class="p-6 md:p-8 overflow-y-auto flex-1 custom-scrollbar space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Surname</label><input
                            type="text" id="student-surname"
                            class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm" required></div>
                    <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">First
                            Name</label><input type="text" id="student-firstname"
                            class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm" required></div>
                </div>
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Middle Name</label><input
                        type="text" id="student-middlename"
                        class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm"></div>
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Address</label><textarea
                        id="student-address" rows="2" class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm"
                        required></textarea></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label
                            class="block text-[11px] font-black text-slate-400 uppercase mb-2">WhatsApp</label><input
                            type="text" id="student-contact"
                            class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm" required></div>
                    <div><label
                            class="block text-[11px] font-black text-slate-400 uppercase mb-2">Password</label><input
                            type="password" id="student-password"
                            class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm" required></div>
                </div>
                <div class="hidden"><input type="radio" name="identifier_type" value="whatsapp" checked></div>
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Class</label><select
                        id="student-grade-level" class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm">
                        <option value="JSS 1">JSS 1</option>
                        <option value="JSS 2">JSS 2</option>
                        <option value="JSS 3">JSS 3</option>
                        <option value="SSS 1">SSS 1</option>
                        <option value="SSS 2">SSS 2</option>
                        <option value="SSS 3">SSS 3</option>
                    </select></div>
            </form>
            <div class="p-6 border-t bg-slate-50 shrink-0"><button type="submit" form="add-student-form"
                    id="submit-student-btn"
                    class="w-full py-3 bg-emerald-800 text-white rounded-xl font-bold uppercase text-xs">Enroll</button>
            </div>
        </div>
    </div>

    <div id="add-post-modal" class="fixed inset-0 z-[110] glass-overlay hidden flex items-center justify-center p-4">
        <div
            class="bg-white w-[95%] md:w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-emerald-900 p-8 text-white text-center shrink-0">
                <h3 class="font-bold text-xl md:text-2xl uppercase">New Post</h3>
            </div>
            <form id="add-post-form" class="p-8 overflow-y-auto flex-1 custom-scrollbar space-y-4">
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Title</label><input
                        type="text" id="post-title" class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm"
                        required></div>
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-2">Content</label><textarea
                        id="post-description" rows="3"
                        class="w-full border-2 border-slate-100 rounded-xl p-3 text-sm resize-none" required></textarea>
                </div>
                <div><label class="block text-[11px] font-black text-slate-400 uppercase mb-3">Media</label><input
                        type="file" id="post-file" class="block w-full text-xs text-slate-500" required></div>
                <div class="flex gap-4"><label><input type="radio" name="post-type" value="image" checked>
                        Image</label><label><input type="radio" name="post-type" value="video"> Video</label></div>
            </form>
            <div class="p-6 border-t bg-slate-50 shrink-0"><button type="submit" form="add-post-form"
                    id="submit-news-btn"
                    class="w-full py-3 bg-emerald-800 text-white rounded-xl font-bold uppercase text-xs">Publish</button>
            </div>
        </div>
    </div>

    <script>
        // 1. INITIALIZE SUPABASE IMMEDIATELY
        const SUPABASE_URL = 'https://yqzpfwkpnywkjhybhccb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxenBmd2twbnl3a2poeWJoY2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NTM0NDYsImV4cCI6MjA4NTQyOTQ0Nn0.xnTFS3cd1akIGQwXE_tOPz6cqtznzZP2eBB_dOZii7M';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. GLOBALS
        lucide.createIcons();
        let currentStudentId = null;

        const CURRENT_SESSION_TERM = "2025/2026 Session - 2nd Term";
        const CLASSES = ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'];
        const JSS_SUBJECTS = ['Mathematics', 'English', 'Integrated Science', 'Social Studies', 'Islamic Studies', 'Arabic', 'Civic Education', 'Hifdh', 'Tajweed'];
        const SSS_SUBJECTS = ['Mathematics', 'English', 'Biology', 'Chemistry', 'Physics', 'Islamic Studies', 'Arabic', 'Geography', 'Economics', 'Civic Education', 'Hifdh', 'Tajweed'];

        const SUBJECT_MAPPING = {
            'Mathematics': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'],
            'English': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'],
            'Islamic Studies': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'],
            'Integrated Science': ['JSS 1', 'JSS 2', 'JSS 3'],
            'Social Studies': ['JSS 1', 'JSS 2', 'JSS 3'],
            'Arabic': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'],
            'Biology': ['SSS 1', 'SSS 2', 'SSS 3'],
            'Chemistry': ['SSS 1', 'SSS 2', 'SSS 3'],
            'Physics': ['SSS 1', 'SSS 2', 'SSS 3'],
            'Civic Education': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'],
            'Geography': ['SSS 1', 'SSS 2', 'SSS 3'],
            'Economics': ['SSS 1', 'SSS 2', 'SSS 3'],
            'Hifdh': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3'],
            'Tajweed': ['JSS 1', 'JSS 2', 'JSS 3', 'SSS 1', 'SSS 2', 'SSS 3']
        };

        // 3. LOAD
        window.onload = function () {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            try { checkActiveSession(); } catch (error) { showNotification("System Failure", "Critical database connection error.", true); }
        };

        // --- AUTH & SETUP ---
        async function checkActiveSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user.user_metadata.role === 'admin') unlockSystem();
        }

        async function handleAdminLogin(e) {
            e.preventDefault(); const btn = document.getElementById('loginBtn'); const orig = btn.innerText; btn.innerText = "Verifying..."; btn.disabled = true;
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value });
                if (error) throw error; if (data.user.user_metadata.role !== 'admin') { await supabaseClient.auth.signOut(); throw new Error("Access Denied"); }
                unlockSystem();
            } catch (err) { showNotification("Login Failed", err.message, true); btn.innerText = orig; btn.disabled = false; }
        }

        function unlockSystem() {
            document.getElementById('auth-container').classList.add('hidden-view');
            document.getElementById('main-dashboard').classList.remove('hidden-view');
            refreshAllData(); toggleTeacherForm('class');
        }

        async function handleLogout() {
            showConfirm("Terminate Session?", "Are you sure you want to log out securely?", async () => { await supabaseClient.auth.signOut(); location.reload(); });
        }

        // --- NAVIGATION ---
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(sec => sec.classList.add('hidden-view'));
            const target = document.getElementById('view-' + viewName);
            if (target) { target.classList.remove('hidden-view'); document.querySelector('main').scrollTop = 0; }
            document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.remove('active-nav'); btn.classList.add('text-emerald-100', 'hover:bg-emerald-900/50'); });
            const activeBtn = document.getElementById('nav-' + viewName);
            if (activeBtn) { activeBtn.classList.add('active-nav'); activeBtn.classList.remove('text-emerald-100', 'hover:bg-emerald-900/50'); }
            if (window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.add('opacity-100'), 10); }
            else { sidebar.classList.add('-translate-x-full'); overlay.classList.remove('opacity-100'); setTimeout(() => overlay.classList.add('hidden'), 300); }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); lucide.createIcons(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleContactInput(type) { const input = document.getElementById('student-contact'); input.placeholder = (type === 'whatsapp') ? "WhatsApp No" : "Email"; document.getElementById('student-contact').focus(); }

        // --- CORE DATA FETCHING ---
        async function refreshAllData() {
            const week = new Date(); week.setDate(week.getDate() - 7);
            await supabaseClient.from('news_posts').delete().lt('created_at', week.toISOString());
            await Promise.all([fetchNewsGrid(), fetchAndRenderTable('teachers', 'teachers-table-body', renderTeacherRow), fetchAndRenderStudents(), calculateDashboardStats()]);
        }

        async function fetchAndRenderTable(table, tbodyId, rowFn) {
            const tbody = document.getElementById(tbodyId); if (!tbody) return;
            const { data } = await supabaseClient.from(table).select('*').order('created_at', { ascending: false });
            tbody.innerHTML = (data && data.length) ? data.map(i => rowFn(i)).join('') : `<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">No records found.</td></tr>`;
            lucide.createIcons();
        }

        async function fetchNewsGrid() {
            const grid = document.getElementById('news-grid');
            const { data } = await supabaseClient.from('news_posts').select('*').order('created_at', { ascending: false });
            grid.innerHTML = (data && data.length) ? data.map(i => {
                const media = i.post_type === 'video' ? `<video src="${i.media_url}" controls playsinline preload="metadata" class="w-full h-48 object-cover bg-black"></video>` : `<img src="${i.media_url}" class="w-full h-48 object-cover">`;
                return `<div class="bg-white rounded-[2rem] border border-slate-100 shadow-xl overflow-hidden hover:-translate-y-1 transition-all group w-full">${media}<div class="p-6"><div class="flex justify-between items-start mb-3"><span class="bg-emerald-50 text-emerald-800 text-[10px] font-black uppercase px-2 py-1 rounded-full tracking-widest">${i.post_type}</span><span class="text-[10px] text-slate-400 font-bold">${new Date(i.created_at).toLocaleDateString()}</span></div><h3 class="font-bold text-xl text-slate-800 mb-2 leading-tight">${i.title}</h3><p class="text-slate-500 text-sm mb-6 line-clamp-3">${i.description}</p><div class="flex gap-2"><button onclick="sharePost('${i.title}','${i.description}','${i.media_url}')" class="flex-1 py-3 border-2 border-emerald-50 text-emerald-600 rounded-xl font-bold text-xs uppercase hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i data-lucide="share-2" class="w-4 h-4"></i> Share</button><button onclick="deleteRecord('news_posts', ${i.id}, '${i.media_path}')" class="p-3 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-xl transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>`;
            }).join('') : '<div class="col-span-full text-center py-20 text-slate-400 italic">No posts available.</div>';
            lucide.createIcons();
        }

        // --- STUDENTS & TRASH ---
        function filterStudents() {
            const query = document.getElementById('student-search').value.toLowerCase();
            document.querySelectorAll('.student-row').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none'; });
        }

        async function fetchAndRenderStudents() {
            const container = document.getElementById('students-container');
            container.innerHTML = '<div class="text-center py-20 text-slate-400 italic">Loading Class Lists...</div>';
            const { data: students, error } = await supabaseClient.from('students').select('*').neq('status', 'Deleted').order('name', { ascending: true });

            if (error || !students) { container.innerHTML = '<div class="text-center text-rose-500 font-bold">Failed to load.</div>'; return; }
            container.innerHTML = '';

            CLASSES.forEach(cls => {
                const classStudents = students.filter(s => s.grade_level === cls);
                const html = `
                    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-xl shadow-slate-200/50 overflow-hidden mb-8">
                        <div class="px-8 py-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><div><h3 class="text-xl font-bold text-slate-800">${cls} Class List</h3><p class="text-xs text-emerald-600 font-bold uppercase tracking-widest mt-1">${CURRENT_SESSION_TERM}</p></div><span class="bg-slate-200 text-slate-600 px-3 py-1 rounded-full text-xs font-bold">${classStudents.length} Students</span></div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-white text-slate-400 font-bold uppercase text-[10px] tracking-widest border-b border-slate-100"><tr><th class="px-8 py-4">Student Identity</th><th class="px-8 py-4">Status</th><th class="px-8 py-4 text-right">Actions</th></tr></thead><tbody class="divide-y divide-slate-100">${classStudents.length > 0 ? classStudents.map(s => renderStudentRow(s)).join('') : '<tr><td colspan="3" class="px-8 py-6 text-center text-slate-400 italic text-xs">No students enrolled.</td></tr>'}</tbody></table></div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
            lucide.createIcons();
        }

        function renderStudentRow(item) {
            return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 student-row"><td class="px-8 py-4"><div class="font-black text-slate-800 text-sm">${item.name}</div><div class="text-[10px] text-emerald-600 font-bold flex items-center mt-1 uppercase tracking-tighter bg-emerald-50 inline-block px-2 py-0.5 rounded-md"><i data-lucide="${item.identifier_type === 'whatsapp' ? 'phone' : 'mail'}" class="w-3 h-3 mr-1.5"></i> ${item.whatsapp_number || item.email}</div></td><td class="px-8 py-4"><span class="text-emerald-800 bg-emerald-100 px-4 py-1.5 rounded-full font-black text-[9px] uppercase tracking-tighter border border-emerald-200 shadow-sm">${item.grade_level}</span></td><td class="px-8 py-4 text-right space-x-2"><button onclick="openStudentManager('${item.id}')" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-emerald-800 shadow-lg transition hover:-translate-y-0.5">Manage</button><button onclick="softDeleteStudent(${item.id})" class="text-slate-300 hover:text-rose-600 transition p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`;
        }

        async function softDeleteStudent(id) {
            showConfirm("Move to Trash?", "Student will be inactive.", async () => {
                await supabaseClient.from('students').update({ status: 'Deleted' }).eq('id', id);
                refreshAllData(); showNotification("Success", "Moved to Trash.");
            });
        }
        async function openTrashModal() {
            document.getElementById('trash-modal').classList.remove('hidden');
            const { data } = await supabaseClient.from('students').select('*').eq('status', 'Deleted');
            const tbody = document.getElementById('trash-table-body'); tbody.innerHTML = '';
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-slate-400">Trash is empty.</td></tr>'; return; }
            data.forEach(s => {
                tbody.insertAdjacentHTML('beforeend', `<tr><td class="p-6 font-bold text-slate-700">${s.name}</td><td class="p-6 text-slate-500">${s.grade_level}</td><td class="p-6 text-right gap-4"><button onclick="restoreStudent(${s.id})" class="text-emerald-600 hover:underline text-xs font-bold mr-4">RESTORE</button><button onclick="permanentDeleteStudent(${s.id})" class="text-rose-600 hover:underline text-xs font-bold">DELETE FOREVER</button></td></tr>`);
            });
        }
        async function restoreStudent(id) { await supabaseClient.from('students').update({ status: 'Active' }).eq('id', id); openTrashModal(); refreshAllData(); showNotification("Success", "Restored."); }
        async function permanentDeleteStudent(id) { if (confirm("Permanently delete? Cannot undo.")) { await supabaseClient.from('students').delete().eq('id', id); openTrashModal(); showNotification("Deleted", "Permanently removed."); } }

        // --- STUDENT MANAGER ---
        async function openStudentManager(id) {
            currentStudentId = id;
            document.getElementById('manage-student-modal').classList.remove('hidden');
            document.getElementById('manage-student-name').innerText = "Loading...";

            const { data: student } = await supabaseClient.from('students').select('*').eq('id', id).single();
            if (!student) return;

            document.getElementById('manage-student-name').innerText = student.name;
            document.getElementById('manage-student-id').innerText = "ID: " + student.id;
            document.getElementById('manage-student-grade').innerText = student.grade_level;
            document.getElementById('manage-student-initials').innerText = student.name.charAt(0);
            document.getElementById('manage-attendance-pct').innerText = (student.attendance_percentage || 100) + "%";
            updateReleaseButtonUI(student.results_released);

            const { data: grades } = await supabaseClient.from('grades').select('*').eq('student_id', id);
            const map = {}; if (grades) grades.forEach(g => map[g.subject_text] = g);

            const subjects = student.grade_level.startsWith('JSS') ? JSS_SUBJECTS : SSS_SUBJECTS;
            const tbody = document.getElementById('grades-table-body'); tbody.innerHTML = '';

            subjects.forEach(sub => {
                const g = map[sub];
                let statusDot = `<span class="w-2 h-2 rounded-full bg-slate-300 inline-block mr-2"></span>`;
                let ca = '-', ex = '-', tot = '-', grd = '-';

                if (g) {
                    statusDot = g.status === 'submitted' ? `<span class="w-2 h-2 rounded-full bg-emerald-500 inline-block mr-2" title="Submitted"></span>` : `<span class="w-2 h-2 rounded-full bg-amber-400 inline-block mr-2" title="Draft"></span>`;
                    if (g.ca_score && g.exam_score) {
                        ca = g.ca_score; ex = g.exam_score;
                        const t = Number(ca) + Number(ex); tot = t;
                        grd = t >= 70 ? 'A' : t >= 60 ? 'B' : t >= 50 ? 'C' : t >= 45 ? 'D' : t >= 40 ? 'E' : 'F';
                    } else {
                        ca = g.ca_score || '-'; ex = g.exam_score || '-';
                    }
                }
                const color = grd === 'F' ? 'text-rose-600 bg-rose-50' : 'text-emerald-700 bg-emerald-50';
                tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-3 md:p-4 font-bold text-slate-800 flex items-center">${statusDot}${sub}</td><td class="p-3 md:p-4 text-center text-slate-500">${ca}</td><td class="p-3 md:p-4 text-center text-slate-500">${ex}</td><td class="p-3 md:p-4 text-center font-black text-slate-800">${tot}</td><td class="p-3 md:p-4 text-center"><span class="${color} px-2 md:px-3 py-1 rounded-lg text-xs font-bold">${grd}</span></td></tr>`);
            });
        }

        async function toggleResultRelease() {
            if (!currentStudentId) return;
            const { data: current } = await supabaseClient.from('students').select('results_released').eq('id', currentStudentId).single();
            const newStatus = !current.results_released;
            const { error } = await supabaseClient.from('students').update({ results_released: newStatus }).eq('id', currentStudentId);
            if (!error) { updateReleaseButtonUI(newStatus); showNotification("Success", newStatus ? "Result Released." : "Result Retracted."); }
        }

        function updateReleaseButtonUI(isReleased) {
            const btn = document.getElementById('release-result-btn');
            const statusText = document.getElementById('manage-result-status');
            if (isReleased) {
                btn.innerHTML = `<i data-lucide="eye-off" class="w-4 h-4 mr-2"></i> Retract Result`;
                btn.classList.replace('bg-emerald-700', 'bg-slate-700');
                statusText.innerHTML = `<span class="w-3 h-3 rounded-full bg-emerald-500"></span> Released`;
            } else {
                btn.innerHTML = `<i data-lucide="send" class="w-4 h-4 mr-2"></i> Release Result`;
                btn.classList.replace('bg-slate-700', 'bg-emerald-700');
                statusText.innerHTML = `<span class="w-3 h-3 rounded-full bg-amber-400"></span> Pending Release`;
            }
            lucide.createIcons();
        }

        async function promptPromotion() {
            const current = document.getElementById('manage-student-grade').innerText;
            const action = prompt(`Modify Progress for ${current}:\nType 'PROMOTE' for next level\nType 'REPEAT' for same level`);
            if (!action) return;
            let next = current;
            if (action.toUpperCase() === 'PROMOTE') {
                if (current === 'JSS 1') next = 'JSS 2'; else if (current === 'JSS 2') next = 'JSS 3'; else if (current === 'JSS 3') next = 'SSS 1'; else if (current === 'SSS 1') next = 'SSS 2'; else if (current === 'SSS 2') next = 'SSS 3'; else next = 'Graduate';
            }
            await supabaseClient.from('students').update({ grade_level: next }).eq('id', currentStudentId);
            refreshAllData(); showNotification("Success", "Updated."); closeModal('manage-student-modal');
        }

        async function releaseAllResults() {
            showConfirm("Bulk Release", "Publish ALL results?", async () => {
                await supabaseClient.from('students').update({ results_released: true }).neq('id', 0);
                showNotification("Success", "Published.");
            });
        }

        function renderTeacherRow(item) {
            let details = item.access_type === 'class' ? `<span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold">${item.access_value}</span>` : `<div class="flex flex-col"><span class="font-bold text-emerald-700">${item.subject}</span><span class="text-[10px] text-slate-400 max-w-[200px] truncate">${item.access_value}</span></div>`;
            return `<tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0"><td class="px-10 py-8"><div class="font-black text-slate-800 text-sm">${item.name}</div><div class="text-[10px] text-slate-400 font-bold mt-1 font-mono">${item.email || '-'}</div></td><td class="px-10 py-8"><span class="${item.access_type === 'class' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'} px-4 py-1.5 rounded-full text-[9px] uppercase font-black tracking-widest border opacity-90">${item.access_type === 'class' ? 'Class Teacher' : 'Subject Teacher'}</span></td><td class="px-10 py-8 text-sm font-black text-slate-600">${details}</td><td class="px-10 py-8 text-right"><button onclick="deleteRecord('teachers', ${item.id})" class="bg-white border-2 border-slate-100 text-slate-400 px-5 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-rose-50 hover:text-rose-600 hover:border-rose-100 transition-all shadow-sm">Revoke</button></td></tr>`;
        }

        // --- TEACHER FORM LOGIC ---
        function toggleTeacherForm(type) {
            const container = document.getElementById('teacher-dynamic-inputs');
            container.innerHTML = '';

            if (type === 'class') {
                let options = CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
                container.innerHTML = `
                    <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-2">Assign Class</label>
                    <select id="teacher-class-select" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-4 text-sm font-bold text-slate-700 outline-none focus:border-emerald-500 appearance-none cursor-pointer">${options}</select>
                `;
            } else {
                let subjOptions = Object.keys(SUBJECT_MAPPING).map(s => `<option value="${s}">${s}</option>`).join('');
                let classCheckboxes = CLASSES.map(c => `
                    <label class="flex items-center space-x-3 p-3 bg-slate-50 rounded-xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition" id="chk-container-${c.replace(/\s+/g, '')}">
                        <input type="checkbox" name="teacher-classes" value="${c}" id="chk-${c.replace(/\s+/g, '')}" class="w-4 h-4 text-emerald-600 rounded border-gray-300 focus:ring-emerald-500">
                        <span class="text-sm font-bold text-slate-600">${c}</span>
                    </label>
                `).join('');
                container.innerHTML = `
                    <div class="mb-4"><label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-2">Assign Subject</label><select id="teacher-subject-select" onchange="updateClassAvailability()" class="w-full border-2 border-slate-100 bg-slate-50 rounded-2xl p-4 text-sm font-bold text-slate-700 outline-none focus:border-emerald-500 appearance-none cursor-pointer">${subjOptions}</select></div>
                    <div><label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-2">Select Classes (Auto-filtered)</label><div class="grid grid-cols-2 md:grid-cols-3 gap-3">${classCheckboxes}</div></div>
                `;
                updateClassAvailability();
            }
        }

        function updateClassAvailability() {
            const subject = document.getElementById('teacher-subject-select').value;
            const allowedClasses = SUBJECT_MAPPING[subject] || [];

            CLASSES.forEach(cls => {
                const cleanName = cls.replace(/\s+/g, '');
                const chk = document.getElementById(`chk-${cleanName}`);
                const container = document.getElementById(`chk-container-${cleanName}`);
                if (allowedClasses.includes(cls)) {
                    chk.disabled = false; container.classList.remove('opacity-40', 'cursor-not-allowed', 'bg-slate-200'); container.classList.add('bg-slate-50', 'cursor-pointer');
                } else {
                    chk.disabled = true; chk.checked = false; container.classList.add('opacity-40', 'cursor-not-allowed', 'bg-slate-200'); container.classList.remove('bg-slate-50', 'cursor-pointer');
                }
            });
        }

        // --- FORM SUBMITS ---
        document.getElementById('add-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-teacher-btn');
            const orig = btn.innerText;
            btn.innerText = "Provisioning...";
            btn.disabled = true;

            try {
                const name = document.getElementById('teacher-name').value;
                const email = document.getElementById('teacher-email').value;
                const pass = document.getElementById('teacher-password').value;
                const type = document.querySelector('input[name="access_type"]:checked').value;

                let val = '';
                let sub = '';

                if (type === 'class') {
                    val = document.getElementById('teacher-class-select').value;
                    sub = 'Class Oversight';
                } else {
                    sub = document.getElementById('teacher-subject-select').value;
                    const chks = document.querySelectorAll('input[name="teacher-classes"]:checked');
                    if (!chks.length) throw new Error("Select at least one class.");
                    val = Array.from(chks).map(c => c.value).join(', ');
                }

                const { data: auth, error: aErr } = await supabaseClient.auth.signUp({
                    email, password: pass, options: { data: { role: 'teacher', full_name: name } }
                });

                if (aErr) throw aErr;

                const { error: dbError } = await supabaseClient.from('teachers').insert([{
                    user_id: auth.user.id, name, email, access_type: type, access_value: val, subject: sub, phone: 'FACULTY'
                }]);

                if (dbError) throw dbError;

                showNotification("Success", "Teacher Account Created.");
                closeModal('add-teacher-modal');
                refreshAllData();
                e.target.reset();

            } catch (err) {
                showNotification("Error", err.message, true);
            } finally {
                btn.innerText = orig;
                btn.disabled = false;
            }
        });

        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-student-btn'); const orig = btn.innerText; btn.innerText = "Syncing..."; btn.disabled = true;
            try {
                const contact = document.getElementById('student-contact').value, idType = document.querySelector('input[name="identifier_type"]:checked').value, loginId = idType === 'whatsapp' ? `${contact.replace(/\D/g, '')}@annoor-academy.com` : contact;
                const { data: auth, error: aErr } = await supabaseClient.auth.signUp({ email: loginId, password: document.getElementById('student-password').value, options: { data: { role: 'student' } } }); if (aErr) throw aErr;
                await supabaseClient.from('students').insert([{ user_id: auth.user.id, name: `${document.getElementById('student-surname').value}, ${document.getElementById('student-firstname').value}`, surname: document.getElementById('student-surname').value, first_name: document.getElementById('student-firstname').value, middle_name: document.getElementById('student-middlename').value, home_address: document.getElementById('student-address').value, identifier_type: idType, whatsapp_number: idType === 'whatsapp' ? contact : null, email: idType === 'email' ? contact : loginId, grade_level: document.getElementById('student-grade-level').value, hifdh_status: 'Juz 1', status: 'Active' }]);
                showNotification("Success", "Student Enrolled."); closeModal('add-student-modal'); refreshAllData(); e.target.reset();
            } catch (err) { showNotification("Error", err.message, true); } finally { btn.innerText = orig; btn.disabled = false; }
        });

        document.getElementById('add-post-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-news-btn'); btn.innerText = "Uploading..."; btn.disabled = true;
            try {
                const title = document.getElementById('post-title').value, desc = document.getElementById('post-description').value, type = document.querySelector('input[name="post-type"]:checked').value, file = document.getElementById('post-file').files[0];
                if (!file) throw new Error("Select file"); if (file.size > 50 * 1024 * 1024) throw new Error("Max 50MB");
                if (type === 'video') { const { count } = await supabaseClient.from('news_posts').select('*', { count: 'exact', head: true }).eq('post_type', 'video'); if (count >= 2) throw new Error("Video limit reached"); }
                const name = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                const { error: uErr } = await supabaseClient.storage.from('news-media').upload(name, file); if (uErr) throw uErr;
                const { data: { publicUrl } } = supabaseClient.storage.from('news-media').getPublicUrl(name);
                await supabaseClient.from('news_posts').insert([{ title, description: desc, post_type: type, media_url: publicUrl, media_path: name }]);
                showNotification("Success", "Published."); closeModal('add-post-modal'); refreshAllData(); e.target.reset();
            } catch (err) { showNotification("Error", err.message, true); } finally { btn.innerText = "Publish Now"; btn.disabled = false; }
        });

        // Utils
        function sharePost(t, x, u) { if (navigator.share) navigator.share({ title: t, text: x, url: u }); else { navigator.clipboard.writeText(u); showNotification("Copied", "Link copied."); } }
        async function deletePostWithMedia(id, p) { showConfirm("Confirm", "Delete?", async () => { if (p) await supabaseClient.storage.from('news-media').remove([p]); await supabaseClient.from('news_posts').delete().eq('id', id); refreshAllData(); showNotification("Deleted", "Removed."); }); }
        async function deleteRecord(t, id) { showConfirm("Confirm", "Delete?", async () => { await supabaseClient.from(t).delete().eq('id', id); refreshAllData(); showNotification("Deleted", "Removed."); }); }
        async function calculateDashboardStats() {
            const { count: s } = await supabaseClient.from('students').select('*', { count: 'exact', head: true });
            const { count: t } = await supabaseClient.from('teachers').select('*', { count: 'exact', head: true });
            const { count: n } = await supabaseClient.from('news_posts').select('*', { count: 'exact', head: true });
            document.getElementById('stat-students').innerText = s || 0;
            document.getElementById('stat-teachers').innerText = t || 0;
            document.getElementById('stat-posts').innerText = n || 0;
        }

        // Helpers
        function showNotification(t, m, e = false) { const md = document.getElementById('custom-alert'); document.getElementById('alert-title').innerText = t; document.getElementById('alert-message').innerText = m; document.getElementById('alert-cancel-btn').classList.add('hidden'); const btn = document.getElementById('alert-ok-btn'); btn.innerText = "Acknowledge"; btn.onclick = closeAlert; document.getElementById('alert-icon').setAttribute('data-lucide', e ? 'x-circle' : 'check-circle'); document.getElementById('alert-icon-bg').className = e ? 'w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-600 shadow-inner' : 'w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600 shadow-inner'; lucide.createIcons(); md.classList.remove('pointer-events-none', 'opacity-0'); md.querySelector('div.transform').classList.replace('scale-95', 'scale-100'); }
        function showConfirm(t, m, cb) { const md = document.getElementById('custom-alert'); document.getElementById('alert-title').innerText = t; document.getElementById('alert-message').innerText = m; document.getElementById('alert-cancel-btn').classList.remove('hidden'); const btn = document.getElementById('alert-ok-btn'); btn.innerText = "Yes, Proceed"; btn.onclick = () => { cb(); closeAlert(); }; document.getElementById('alert-icon').setAttribute('data-lucide', 'alert-circle'); document.getElementById('alert-icon-bg').className = 'w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6 text-amber-600 shadow-inner'; lucide.createIcons(); md.classList.remove('pointer-events-none', 'opacity-0'); md.querySelector('div.transform').classList.replace('scale-95', 'scale-100'); }
        function closeAlert() { const md = document.getElementById('custom-alert'); md.classList.add('opacity-0'); md.querySelector('div.transform').classList.replace('scale-100', 'scale-95'); setTimeout(() => md.classList.add('pointer-events-none'), 300); }
        function toggleSidebar() { const s = document.getElementById('sidebar'); const o = document.getElementById('mobile-overlay'); if (s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); setTimeout(() => o.classList.add('opacity-100'), 10); } else { s.classList.add('-translate-x-full'); o.classList.remove('opacity-100'); setTimeout(() => o.classList.add('hidden'), 300); } }
        function switchView(v) { document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden-view')); document.getElementById('view-' + v).classList.remove('hidden-view'); document.querySelectorAll('nav button').forEach(b => { b.classList.remove('active-nav'); b.classList.add('hover:bg-emerald-900/50'); }); const b = document.getElementById('nav-' + v); if (b) { b.classList.add('active-nav'); b.classList.remove('hover:bg-emerald-900/50'); } if (window.innerWidth < 768) toggleSidebar(); }
        function handleLogout() { showConfirm("Logout?", "End session?", async () => { await supabaseClient.auth.signOut(); location.reload(); }); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); } function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleContactInput(type) { document.getElementById('student-contact').placeholder = (type === 'whatsapp') ? "WhatsApp No" : "Email"; document.getElementById('student-contact').focus(); }
    </script>
</body>

</html>
