<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subulus Salaam | Teacher Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        .hidden-view {
            display: none !important;
        }

        .active-nav {
            background-color: #0f766e !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .teacher-bg {
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, #1e293b 0, transparent 50%), radial-gradient(at 100% 100%, #0f172a 0, transparent 50%);
        }

        .pattern-overlay {
            background-image: url("https://www.transparenttextures.com/patterns/arabesque.png");
            opacity: 0.05;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #0f766e;
            border-radius: 10px;
        }

        input:disabled,
        select:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        #qr-reader {
            border: none !important;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0f766e;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .cursor-not-allowed {
            cursor: not-allowed !important;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden font-sans antialiased">

    <div id="custom-alert"
        class="fixed inset-0 z-[200] flex items-center justify-center px-4 pointer-events-none opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div
            class="bg-white rounded-[2rem] shadow-2xl p-8 max-w-sm w-full transform scale-95 transition-all duration-300 relative z-10 text-center border-4 border-white/50">
            <div id="alert-icon-bg"
                class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-6 text-teal-700 shadow-inner">
                <i id="alert-icon" data-lucide="check-circle" class="w-10 h-10"></i>
            </div>
            <h3 id="alert-title" class="text-2xl font-bold text-slate-800 mb-2 font-serif">Success</h3>
            <p id="alert-message" class="text-slate-500 text-sm font-medium mb-8 leading-relaxed">Operation completed.
            </p>
            <div class="flex gap-4">
                <button id="alert-cancel-btn" onclick="closeAlert()"
                    class="hidden flex-1 py-4 border-2 border-slate-100 text-slate-400 rounded-2xl font-bold hover:bg-slate-50 transition active:scale-95">Cancel</button>
                <button id="alert-ok-btn" onclick="closeAlert()"
                    class="flex-1 py-4 bg-teal-900 text-white rounded-2xl font-bold shadow-xl shadow-teal-900/20 hover:bg-teal-800 hover:-translate-y-1 transition-all active:scale-95">Acknowledge</button>
            </div>
        </div>
    </div>

    <div id="auth-container"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 teacher-bg transition-all duration-700">
        <a href="index.html"
            class="absolute top-6 left-6 z-[120] flex items-center gap-3 text-white/80 hover:text-white transition-colors group cursor-pointer">
            <div
                class="p-2.5 bg-white/10 rounded-full backdrop-blur-md border border-white/10 group-hover:bg-white/20 transition-all shadow-lg">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </div>
            <span
                class="text-sm font-bold tracking-wider uppercase opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0 duration-300">Return
                Home</span>
        </a>

        <div
            class="w-full max-w-4xl bg-white rounded-[2rem] shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[550px] relative z-10">
            <div
                class="hidden md:flex w-1/2 bg-slate-900 relative flex-col justify-between p-12 text-white overflow-hidden">
                <div class="absolute inset-0 pattern-overlay"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-10 h-10 bg-teal-500 rounded-lg flex items-center justify-center text-white shadow-lg">
                            <i data-lucide="book-open" class="w-6 h-6"></i>
                        </div>
                        <span class="text-teal-400 font-bold tracking-widest uppercase text-xs">Faculty Access</span>
                    </div>
                    <h1 class="text-4xl font-bold font-serif leading-tight mt-6">Educator<br><span
                            class="text-teal-400">Portal</span></h1>
                    <p class="mt-6 text-slate-400 text-sm leading-relaxed">Manage your classes, grades, and attendance
                        seamlessly synced with the admin system.</p>
                </div>
            </div>
            <div class="w-full md:w-1/2 bg-white p-8 md:p-12 flex flex-col justify-center">
                <div class="max-w-xs mx-auto w-full">
                    <div class="md:hidden text-center mb-6">
                        <div
                            class="w-12 h-12 bg-teal-500 rounded-lg flex items-center justify-center text-white shadow-lg mx-auto mb-2">
                            <i data-lucide="book-open" class="w-6 h-6"></i>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800">Faculty Portal</h2>
                    </div>
                    <div class="mb-8 hidden md:block">
                        <h2 class="text-2xl font-bold text-slate-800">Teacher Sign In</h2>
                        <p class="text-slate-400 mt-2 text-xs">Access your assigned classes.</p>
                    </div>
                    <form id="teacherLoginForm" onsubmit="handleTeacherLogin(event)" class="space-y-5">
                        <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Email</label><input
                                type="email" id="login-email"
                                class="w-full mt-2 bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 text-sm font-semibold text-slate-700 outline-none focus:border-teal-600 transition-all"
                                placeholder="ustadh@academy.com" required></div>
                        <div><label
                                class="text-xs font-bold text-slate-500 uppercase tracking-wide">Password</label><input
                                type="password" id="login-password"
                                class="w-full mt-2 bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 text-sm font-semibold text-slate-700 outline-none focus:border-teal-600 transition-all"
                                placeholder="••••••••" required></div>
                        <button type="submit" id="loginBtn"
                            class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-teal-900 transition-all active:scale-95 flex items-center justify-center gap-2"><span>Enter
                                Portal</span><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden-view flex h-screen w-full transition-opacity duration-700">
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-30 w-72 bg-slate-900 text-white flex flex-col border-r border-slate-800 transform -translate-x-full md:translate-x-0 md:relative sidebar-transition shadow-2xl md:shadow-none h-full">
            <div class="h-24 flex items-center justify-between px-6 border-b border-slate-800">
                <div class="flex items-center"><i data-lucide="book-open" class="w-8 h-8 text-teal-400 mr-3"></i><span
                        class="font-bold text-lg tracking-tight">Faculty</span></div>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>
            <nav class="flex-1 py-8 px-4 space-y-3 overflow-y-auto">
                <button onclick="switchView('dashboard')" id="nav-dashboard"
                    class="w-full flex items-center px-4 py-4 rounded-xl active-nav transition-all group"><i
                        data-lucide="layout-grid" class="w-5 h-5 mr-3"></i><span class="text-sm font-medium">My
                        Classes</span></button>
                <button onclick="switchView('attendance')" id="nav-attendance"
                    class="w-full flex items-center px-4 py-4 rounded-xl hover:bg-slate-800 transition-all group"><i
                        data-lucide="user-check" class="w-5 h-5 mr-3"></i><span class="text-sm font-medium">Daily
                        Attendance</span></button>
                <div class="pt-6 px-2">
                    <p class="text-[10px] uppercase text-slate-500 font-bold tracking-widest mb-3">Your Profile</p>
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-800">
                        <p id="profile-name" class="text-white font-bold text-sm mb-1 truncate">Loading...</p>
                        <p id="profile-role" class="text-xs text-teal-400 font-mono uppercase tracking-wide">...</p>
                    </div>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-800"><button onclick="handleLogout()"
                    class="w-full flex items-center justify-center px-4 py-3 text-rose-400 hover:bg-rose-900/20 rounded-xl transition-all border border-transparent hover:border-rose-900/30"><i
                        data-lucide="log-out" class="w-5 h-5 mr-3"></i><span class="text-sm font-bold">Sign
                        Out</span></button></div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
            <div id="mobile-overlay" onclick="toggleSidebar()"
                class="fixed inset-0 z-20 bg-slate-900/50 backdrop-blur-sm hidden transition-opacity opacity-0 md:hidden">
            </div>

            <header
                class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0 shadow-sm/50">
                <div class="flex items-center"><button onclick="toggleSidebar()"
                        class="md:hidden mr-4 text-slate-500 hover:text-teal-700 bg-slate-50 p-2 rounded-lg"><i
                            data-lucide="menu" class="w-6 h-6"></i></button>
                    <h2 class="text-lg md:text-xl font-bold text-slate-800 truncate" id="page-title">Dashboard</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-xs text-right hidden sm:block">
                        <p class="font-bold text-slate-900">Session</p>
                        <p class="text-teal-600" id="session-term-display">Loading...</p>
                    </div>
                </div>
            </header>

            <div id="view-dashboard" class="view-section flex-1 overflow-y-auto p-4 md:p-10">
                <div class="max-w-5xl mx-auto">
                    <div class="mb-6 md:mb-8">
                        <h1 class="text-2xl md:text-3xl font-black text-slate-800 mb-2">Welcome, Ustadh.</h1>
                        <p class="text-slate-500 text-sm md:text-base">Select a class below to manage grades.</p>
                    </div>
                    <div id="class-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="col-span-full text-center py-20 text-slate-400 italic">Loading your assignments...
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-grading" class="view-section hidden-view flex-1 flex flex-col h-full overflow-hidden">
                <div
                    class="bg-white border-b border-slate-200 p-4 md:p-6 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 shrink-0">
                    <div class="flex items-center gap-3 w-full lg:w-auto">
                        <button onclick="switchView('dashboard')"
                            class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition shrink-0"><i
                                data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i></button>
                        <div class="truncate">
                            <h2 class="text-xl font-bold text-slate-800" id="grade-class-title">Class</h2>
                            <p class="text-[10px] text-teal-600 font-bold uppercase tracking-widest truncate"
                                id="grade-role-badge">Role</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto">
                        <div class="w-full sm:w-auto"><select id="grading-subject-select" onchange="loadGradebook()"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 outline-none focus:border-teal-500"></select>
                        </div>
                        <button id="btn-submit-admin" onclick="submitToAdmin()"
                            class="w-full sm:w-auto bg-teal-700 text-white px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg hover:bg-teal-800 transition-all flex items-center justify-center disabled:bg-slate-300 disabled:cursor-not-allowed"><i
                                data-lucide="send" class="w-4 h-4 mr-2"></i> Submit to Admin</button>
                    </div>
                </div>
                <div class="flex-1 overflow-x-auto overflow-y-auto p-4 md:p-8 bg-slate-50">
                    <div
                        class="bg-white rounded-[1.5rem] border border-slate-200 shadow-xl min-w-[800px] md:min-w-full">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead
                                class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase text-[10px] tracking-widest">
                                <tr>
                                    <th class="p-4">Student Name</th>
                                    <th class="p-4 text-center w-24">CA (40)</th>
                                    <th class="p-4 text-center w-24">Exam (60)</th>
                                    <th class="p-4 text-center w-24">Total</th>
                                    <th class="p-4 text-center w-24">Grade</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="gradebook-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-attendance" class="view-section hidden-view flex-1 flex flex-col h-full overflow-hidden">
                <div class="bg-white border-b border-slate-200 p-4 md:p-6 shrink-0">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="w-full md:w-auto">
                            <h2 class="text-xl font-bold text-slate-800">Attendance</h2>
                            <div class="flex flex-col sm:flex-row gap-2 mt-2 w-full">
                                <select id="att-class-select" onchange="loadAttendance()"
                                    class="bg-slate-100 border-none rounded-lg px-3 py-2 text-xs font-bold text-slate-700 outline-none w-full sm:w-auto"></select>
                                <input type="date" id="att-date"
                                    class="bg-slate-100 border-none rounded-lg px-3 py-2 text-xs font-bold text-slate-700 outline-none w-full sm:w-auto"
                                    onchange="loadAttendance()">
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="toggleScanner()"
                                class="flex-1 md:flex-none bg-slate-800 text-white px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-slate-900 transition flex items-center justify-center"><i
                                    data-lucide="qr-code" class="w-4 h-4 mr-2"></i> Scan QR</button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                    <div id="scanner-container"
                        class="hidden absolute inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4">
                        <div class="bg-white p-2 rounded-2xl w-full max-w-sm">
                            <div id="qr-reader" class="rounded-xl overflow-hidden border-2 border-teal-500"></div>
                        </div>
                        <button onclick="toggleScanner()"
                            class="mt-6 bg-white/10 text-white px-8 py-3 rounded-full font-bold hover:bg-white/20 transition backdrop-blur-sm">Close
                            Scanner</button>
                    </div>
                    <div class="max-w-4xl mx-auto bg-white rounded-[1.5rem] border border-slate-200 shadow-xl overflow-hidden"
                        id="attendance-list-container">
                        <div
                            class="p-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-3">
                            <input type="text" id="att-search" onkeyup="filterAttendance()"
                                placeholder="Search student..."
                                class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none w-full sm:w-64">
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="printDailyRegister()"
                                    class="flex-1 sm:flex-none bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-slate-200 transition border border-slate-200 flex items-center justify-center"><i
                                        data-lucide="printer" class="w-4 h-4 mr-2"></i> Print</button>
                                <button onclick="saveBulkAttendance()"
                                    class="flex-1 sm:flex-none bg-teal-700 text-white px-6 py-2 rounded-xl text-xs font-bold uppercase hover:bg-teal-800 transition">Save
                                    All</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead
                                    class="bg-slate-50 border-b border-slate-100 text-slate-500 font-bold uppercase text-[10px] tracking-widest">
                                    <tr>
                                        <th class="px-4 py-3">Student</th>
                                        <th class="px-4 py-3 text-center">Status</th>
                                        <th class="px-4 py-3 text-right">Time</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


<script>
        // 1. INITIALIZE SUPABASE
        const SUPABASE_URL = 'https://yqzpfwkpnywkjhybhccb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxenBmd2twbnl3a2poeWJoY2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NTM0NDYsImV4cCI6MjA4NTQyOTQ0Nn0.xnTFS3cd1akIGQwXE_tOPz6cqtznzZP2eBB_dOZii7M';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. CONFIGURATION
        const CURRENT_SESSION_TERM = "2025/2026 Session - 3rd Term";
        const SUBJECTS_JSS = ['Tafsir', 'Fiqhu', 'Sirah', 'Tarbiyya', 'Hausa', 'Nahwu', 'Adab', 'Sarfu', 'Arabiyya', 'General Knowledge', 'Hadith', 'Tauhid', "Muda'li'ah"];
        const SUBJECTS_UPPER_PRI = ["Qur'an", 'Hadith', 'Tauhid', 'Tajwid', 'Arabiyya', 'Sira'];
        const SUBJECTS_MIDDLE_PRI = ["Qur'an", 'Hadith', 'Tauhid', 'Tajwid', 'Arabiyya', "Insha'i", 'Huruf'];
        const SUBJECTS_LOWER_NUR = ["Qur'an", 'Hadith', 'Tauhid', 'Tajwid', 'Arabiyya', 'Huruf'];

        let currentUser = null;
        let activeClass = null;
        
        // Use the Core Engine instead of the Widget
        let html5QrCode = null; 

        // 3. INITIALIZATION
        window.onload = function () {
            lucide.createIcons();
            
            // *** CSS INJECTION FOR FULLSCREEN CAMERA ***
            const style = document.createElement('style');
            style.innerHTML = `
                /* Fullscreen Overlay */
                #scanner-container { 
                    position: fixed !important; 
                    top: 0; left: 0; width: 100vw; height: 100vh; 
                    background: #000; z-index: 99999; 
                    display: flex; flex-direction: column; 
                }
                #scanner-container.hidden { display: none !important; }
                
                /* Video Area */
                #qr-reader { 
                    flex: 1; 
                    width: 100% !important; 
                    height: 100% !important; 
                    overflow: hidden; 
                    position: relative;
                }
                
                /* Force Video to Cover Screen */
                #qr-reader video { 
                    object-fit: cover !important; 
                    width: 100% !important; 
                    height: 100% !important; 
                }
                
                /* Overlay Controls */
                .scan-overlay-ui {
                    position: absolute; bottom: 40px; left: 0; right: 0;
                    display: flex; justify-content: center; z-index: 100000;
                }
                .scan-guide-box {
                    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    width: 250px; height: 250px;
                    border: 2px solid rgba(255,255,255,0.7);
                    border-radius: 20px;
                    box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); /* Dim background */
                    pointer-events: none;
                }
            `;
            document.head.appendChild(style);

            const sessionDisplay = document.getElementById('session-term-display');
            if (sessionDisplay) sessionDisplay.innerText = CURRENT_SESSION_TERM;

            const attDateInput = document.getElementById('att-date');
            if (attDateInput) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                attDateInput.value = `${year}-${month}-${day}`;
            }

            checkActiveSession();
        };

        // --- GLOBAL FUNCTIONS ---

        function getSubjectsForClass(className) {
            if (!className) return [];
            if (['JSS 1', 'JSS 2'].includes(className)) return SUBJECTS_JSS;
            if (className === 'Primary 5') return SUBJECTS_UPPER_PRI;
            if (['Primary 2', 'Primary 3', 'Primary 4'].includes(className)) return SUBJECTS_MIDDLE_PRI;
            if (['Nursery 4', 'Nursery 5', 'Primary 1'].includes(className)) return SUBJECTS_LOWER_NUR;
            return [];
        }

        async function checkActiveSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user.user_metadata.role === 'teacher') {
                initPortal(session.user);
            } else if (session) {
                await supabaseClient.auth.signOut();
            }
        }

        async function handleTeacherLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `Verifying...`;
            btn.disabled = true;

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                if (data.user.user_metadata.role !== 'teacher') {
                    await supabaseClient.auth.signOut();
                    throw new Error("Unauthorized: Teachers only.");
                }
                initPortal(data.user);
            } catch (err) {
                showNotification("Login Failed", err.message, true);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function initPortal(user) {
            try {
                const { data: teacher, error } = await supabaseClient.from('teachers').select('*').eq('user_id', user.id).single();
                if (error || !teacher) { showNotification("Error", "Teacher profile not found.", true); return; }

                currentUser = teacher;
                document.getElementById('auth-container').classList.add('hidden-view');
                document.getElementById('main-dashboard').classList.remove('hidden-view');
                document.getElementById('profile-name').innerText = teacher.name;
                document.getElementById('profile-role').innerText = teacher.access_type === 'class' ? "Class Teacher" : "Subject Teacher";

                const select = document.getElementById('att-class-select');
                if (select && teacher.access_value) {
                    select.innerHTML = '';
                    const assignedClasses = teacher.access_value.split(',').map(s => s.trim());
                    assignedClasses.forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; });
                }
                renderDashboard();
            } catch (err) { console.error(err); showNotification("Error", "Failed to load portal.", true); }
        }

        function renderDashboard() {
            const grid = document.getElementById('class-grid');
            grid.innerHTML = '';
            if (!currentUser.access_value) { grid.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400">No classes assigned.</div>'; return; }
            const assignedClasses = currentUser.access_value.split(',').map(s => s.trim());
            assignedClasses.forEach(cls => {
                const isClassTeacher = currentUser.access_type === 'class';
                const subText = isClassTeacher ? "Full Management" : `${currentUser.subject} Teacher`;
                const icon = isClassTeacher ? 'users' : 'book';
                const color = isClassTeacher ? 'teal' : 'slate';
                const card = `<div onclick="openClass('${cls}')" class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-lg hover:-translate-y-1 transition-all cursor-pointer group"><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 bg-${color}-50 text-${color}-600 rounded-xl flex items-center justify-center"><i data-lucide="${icon}" class="w-5 h-5"></i></div><span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-widest group-hover:bg-${color}-600 group-hover:text-white transition">Open</span></div><h3 class="text-xl font-bold text-slate-800">${cls}</h3><p class="text-xs text-slate-400 font-medium mt-1 truncate" title="${subText}">${subText}</p></div>`;
                grid.insertAdjacentHTML('beforeend', card);
            });
            lucide.createIcons();
        }

        async function openClass(className) {
            activeClass = className;
            switchView('grading');
            document.getElementById('grade-class-title').innerText = className;
            const select = document.getElementById('grading-subject-select');
            select.innerHTML = '';

            if (currentUser.access_type === 'subject') {
                const assignedSubjects = currentUser.subject ? currentUser.subject.split(',').map(s => s.trim()) : [];
                if (assignedSubjects.length > 0) {
                    assignedSubjects.forEach(sub => { select.innerHTML += `<option value="${sub}">${sub}</option>`; });
                    if (assignedSubjects.length > 1) { select.disabled = false; document.getElementById('grade-role-badge').innerText = "Multi-Subject Teacher"; }
                    else { select.disabled = true; document.getElementById('grade-role-badge').innerText = `Subject: ${assignedSubjects[0]}`; }
                } else { select.innerHTML = '<option>No subjects</option>'; select.disabled = true; }
            } else {
                const subjects = getSubjectsForClass(className);
                subjects.forEach(sub => select.innerHTML += `<option value="${sub}">${sub}</option>`);
                select.disabled = false; document.getElementById('grade-role-badge').innerText = "Class Teacher";
            }
            loadGradebook();
        }

        // --- GRADING ---
        async function loadGradebook() {
            const tbody = document.getElementById('gradebook-body');
            tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-slate-400 italic">Loading...</td></tr>';
            const subject = document.getElementById('grading-subject-select').value;
            const { data: students, error: sErr } = await supabaseClient.from('students').select('*').eq('grade_level', activeClass).neq('status', 'Deleted').order('name');
            if (sErr || !students || students.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-slate-400 italic">No students found.</td></tr>'; return; }
            const { data: grades } = await supabaseClient.from('grades').select('*').eq('subject_text', subject).eq('term', CURRENT_SESSION_TERM).in('student_id', students.map(s => s.id));
            updateSubmitButtonUI(); tbody.innerHTML = '';
            const gradeMap = {};
            if (grades) grades.forEach(g => gradeMap[g.student_id] = g);
            students.forEach(s => {
                const g = gradeMap[s.id] || { ca_score: null, exam_score: null, status: 'draft' };
                const isRowLocked = g.status === 'submitted';
                const disabledAttr = isRowLocked ? 'disabled' : '';
                const bgClass = isRowLocked ? 'bg-slate-100 cursor-not-allowed' : 'bg-white';
                const ca = g.ca_score; const exam = g.exam_score;
                const hasScore = (ca !== null && ca !== undefined) || (exam !== null && exam !== undefined);
                const total = hasScore ? ((Number(ca) || 0) + (Number(exam) || 0)) : '-';
                let gradeChar = '-'; if (total !== '-') gradeChar = total >= 70 ? 'A' : total >= 60 ? 'B' : total >= 50 ? 'C' : total >= 45 ? 'D' : total >= 40 ? 'E' : 'F';
                const caVal = ca === null || ca === undefined ? '' : ca; const examVal = exam === null || exam === undefined ? '' : exam;
                const row = `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 group"><td class="px-4 py-3 font-bold text-slate-700 min-w-[150px]">${s.name}</td><td class="px-4 py-3 text-center"><input type="number" id="ca-${s.id}" value="${caVal}" max="40" oninput="updateRowTotal('${s.id}')" ${disabledAttr} class="w-16 ${bgClass} border border-slate-200 rounded-lg py-2 text-center font-bold outline-none focus:border-teal-500 transition placeholder-slate-300"></td><td class="px-4 py-3 text-center"><input type="number" id="exam-${s.id}" value="${examVal}" max="60" oninput="updateRowTotal('${s.id}')" ${disabledAttr} class="w-16 ${bgClass} border border-slate-200 rounded-lg py-2 text-center font-bold outline-none focus:border-teal-500 transition placeholder-slate-300"></td><td class="px-4 py-3 text-center font-black text-slate-800" id="total-${s.id}">${total}</td><td class="px-4 py-3 text-center"><span id="grade-${s.id}" class="px-2 py-1 rounded-lg text-xs font-black bg-slate-100 text-slate-500">${gradeChar}</span></td><td class="px-4 py-3 text-right">${!isRowLocked ? `<button onclick="saveStudentGrade('${s.id}')" class="bg-slate-800 text-white p-2 rounded-lg hover:bg-teal-600 transition shadow-lg active:scale-90"><i data-lucide="save" class="w-4 h-4"></i></button>` : `<span class="flex items-center justify-end text-xs text-teal-600 font-bold"><i data-lucide="lock" class="w-3 h-3 mr-1"></i> Locked</span>`}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            lucide.createIcons();
        }

        function updateRowTotal(id) {
            const caInput = document.getElementById(`ca-${id}`); const examInput = document.getElementById(`exam-${id}`);
            let caVal = caInput.value; let examVal = examInput.value;
            if (Number(caVal) > 40) { caVal = 40; caInput.value = 40; }
            if (Number(examVal) > 60) { examVal = 60; examInput.value = 60; }
            if (caVal === '' && examVal === '') { document.getElementById(`total-${id}`).innerText = '-'; document.getElementById(`grade-${id}`).innerText = '-'; return; }
            const total = (Number(caVal) || 0) + (Number(examVal) || 0);
            document.getElementById(`total-${id}`).innerText = total;
            document.getElementById(`grade-${id}`).innerText = total >= 70 ? 'A' : total >= 60 ? 'B' : total >= 50 ? 'C' : total >= 45 ? 'D' : total >= 40 ? 'E' : 'F';
        }

        async function saveStudentGrade(studentId) {
            const subject = document.getElementById('grading-subject-select').value;
            const ca = document.getElementById(`ca-${studentId}`).value;
            const exam = document.getElementById(`exam-${studentId}`).value;
            const finalCa = ca === '' ? null : ca;
            const finalExam = exam === '' ? null : exam;
            let total = null; if (finalCa !== null || finalExam !== null) total = (Number(finalCa) || 0) + (Number(finalExam) || 0);
            const { data, error } = await supabaseClient.from('grades').update({ ca_score: finalCa, exam_score: finalExam, total_score: total, status: 'draft' }).eq('student_id', studentId).eq('subject_text', subject).eq('term', CURRENT_SESSION_TERM).select();
            if (!error && data.length > 0) { showNotification("Saved", "Grade updated."); return; }
            const { error: insertError } = await supabaseClient.from('grades').insert([{ student_id: studentId, subject_text: subject, term: CURRENT_SESSION_TERM, ca_score: finalCa, exam_score: finalExam, total_score: total, status: 'draft' }]);
            if (insertError) { showNotification("Error", "Failed to save grade.", true); } else { showNotification("Saved", "New grade created."); }
        }

        async function submitToAdmin() {
            const subject = document.getElementById('grading-subject-select').value;
            const cls = document.getElementById('grade-class-title').innerText;
            const { count } = await supabaseClient.from('grades').select('*', { count: 'exact', head: true }).eq('subject_text', subject).eq('term', CURRENT_SESSION_TERM).eq('status', 'draft').not('total_score', 'is', null);
            if (count === 0) { showNotification("Info", "No recorded drafts to submit.", true); return; }
            showConfirm("Submit Grades?", `Lock ${count} records?`, async () => {
                const { data: students } = await supabaseClient.from('students').select('id').eq('grade_level', cls);
                if (!students || !students.length) return;
                const studentIds = students.map(s => s.id);
                const { error } = await supabaseClient.from('grades').update({ status: 'submitted' }).in('student_id', studentIds).eq('subject_text', subject).eq('term', CURRENT_SESSION_TERM).eq('status', 'draft').not('total_score', 'is', null);
                if (error) showNotification("Error", "Submission failed.", true); else { showNotification("Success", "Grades Submitted."); loadGradebook(); }
            });
        }

        function updateSubmitButtonUI() {
            const btn = document.getElementById('btn-submit-admin');
            btn.innerHTML = `<i data-lucide="send" class="w-4 h-4 mr-2"></i> Submit Drafts`; btn.disabled = false; btn.classList.remove('bg-slate-400'); btn.classList.add('bg-teal-700'); lucide.createIcons();
        }

        // --- ATTENDANCE ---
        async function loadAttendance() {
            const cls = document.getElementById('att-class-select').value;
            const dateStr = document.getElementById('att-date').value;
            const tbody = document.getElementById('attendance-body');
            tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-slate-400 italic">Loading...</td></tr>';
            const { data: students } = await supabaseClient.from('students').select('*').eq('grade_level', cls).neq('status', 'Deleted').order('name');
            const { data: attendance } = await supabaseClient.from('attendance').select('*').eq('date', dateStr).eq('class_name', cls);
            const attMap = {}; if (attendance) attendance.forEach(a => attMap[a.student_id] = a);
            tbody.innerHTML = '';
            if (!students || !students.length) { tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-slate-400 italic">No students.</td></tr>'; return; }
            students.forEach(s => {
                const record = attMap[s.id]; const isMarked = !!record; const isPresent = record && record.status === 'Present';
                const time = record ? new Date(record.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-';
                const statusText = isMarked ? (isPresent ? 'Present' : 'Absent') : 'Absent';
                const disabledAttr = isMarked ? 'disabled' : '';
                const cursorClass = isMarked ? 'cursor-not-allowed opacity-60' : 'cursor-pointer';
                const row = `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 att-row" data-id="${s.id}"><td class="px-4 py-3 font-bold text-slate-700">${s.name}</td><td class="px-4 py-3 text-center"><label class="relative inline-flex items-center ${cursorClass}"><input type="checkbox" class="sr-only peer" ${isPresent ? 'checked' : ''} ${disabledAttr} onchange="toggleAttendanceStatus(this)"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div><span class="ml-3 text-xs font-medium text-slate-600 status-label">${statusText}</span></label></td><td class="px-4 py-3 text-right text-xs text-slate-400 font-mono">${time}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function toggleAttendanceStatus(checkbox) { checkbox.parentNode.querySelector('.status-label').innerText = checkbox.checked ? 'Present' : 'Absent'; }

        // *** ROBUST SCANNER IMPLEMENTATION (Fixes "Overconstrained" & "Blind") ***
        async function toggleScanner() {
            const cls = document.getElementById('att-class-select').value;
            const dateStr = document.getElementById('att-date').value;

            if (!cls || !dateStr) {
                showNotification("Action Required", "Please select a Class and Date before scanning.", true);
                return;
            }

            const container = document.getElementById('scanner-container');
            const readerDiv = document.getElementById('qr-reader');

            if (container.classList.contains('hidden')) {
                // OPEN SCANNER
                container.classList.remove('hidden');
                
                // Add Overlay HTML if not present
                if (!document.querySelector('.scan-guide-box')) {
                    readerDiv.insertAdjacentHTML('beforeend', `
                        <div class="scan-guide-box"></div>
                        <div class="scan-overlay-ui">
                            <button onclick="toggleScanner()" class="bg-white/20 backdrop-blur-md text-white px-8 py-4 rounded-full font-bold border border-white/30 shadow-2xl hover:bg-white/30 transition">Stop Scanning</button>
                        </div>
                    `);
                }

                try {
                    // 1. Init Core Class (Not Scanner Widget)
                    html5QrCode = new Html5Qrcode("qr-reader");

                    // 2. Get Camera List
                    const devices = await Html5Qrcode.getCameras();
                    
                    if (devices && devices.length) {
                        // 3. Smart Select: Try to find "back" or "environment" camera
                        let cameraId = devices[0].id; // Default to first
                        
                        // Look for back camera
                        const backCam = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                        if (backCam) cameraId = backCam.id;

                        // 4. Start Scanning (Specific ID avoids "Overconstrained")
                        await html5QrCode.start(
                            cameraId, 
                            {
                                fps: 10,
                                qrbox: { width: 250, height: 250 }, // Square box
                                aspectRatio: 1.0
                            },
                            onScanSuccess
                        );
                    } else {
                        // Fallback if permission issues or no ID returned (Desktop fallback)
                        await html5QrCode.start(
                            { facingMode: "environment" }, // Generic request
                            { fps: 10, qrbox: 250 },
                            onScanSuccess
                        );
                    }

                } catch (err) {
                    console.error("Camera Error: ", err);
                    
                    // Fallback for Desktop/Laptop "Overconstrained" issue
                    // If "environment" failed, try "user" (Webcam)
                    try {
                        await html5QrCode.start(
                            { facingMode: "user" }, 
                            { fps: 10, qrbox: 250 },
                            onScanSuccess
                        );
                    } catch (retryErr) {
                        alert("Camera failed to start. Check permissions.");
                        toggleScanner(); // Close
                    }
                }

            } else {
                // CLOSE SCANNER
                if (html5QrCode) {
                    try {
                        await html5QrCode.stop();
                        await html5QrCode.clear();
                    } catch(e) { console.log(e); }
                    html5QrCode = null;
                }
                container.classList.add('hidden');
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // Rate limiter or debounce could go here, but pausing scanner is safer
            if(html5QrCode && html5QrCode.isScanning) {
                await html5QrCode.pause(); // Pause to prevent double scan
            }

            const c = document.getElementById('att-class-select').value;
            const dateStr = document.getElementById('att-date').value;
            
            // Logic
            const { data: s } = await supabaseClient.from('students').select('*').eq('id', decodedText).eq('grade_level', c).single();
            
            if (!s) { 
                showNotification("Error", "Student not in this class!", true);
                setTimeout(() => html5QrCode.resume(), 2000); // Resume after alert
                return; 
            }

            const { data: existing } = await supabaseClient.from('attendance').select('id').eq('student_id', decodedText).eq('date', dateStr).single();
            if (existing) { 
                showNotification("Info", `${s.name} already marked.`, true);
                setTimeout(() => html5QrCode.resume(), 2000);
                return; 
            }

            const { error } = await supabaseClient.from('attendance').insert({ student_id: decodedText, class_name: c, date: dateStr, status: 'Present', marked_by: currentUser.user_id });
            
            if(!error) {
                new Audio('https://actions.google.com/sounds/v1/science_fiction/beep_short.ogg').play().catch(e => console.log(e));
                loadAttendance();
                // Custom Scanner Success UI
                const guideBox = document.querySelector('.scan-guide-box');
                if(guideBox) {
                    guideBox.style.borderColor = '#10b981'; // Green
                    guideBox.style.boxShadow = '0 0 0 9999px rgba(16, 185, 129, 0.2)';
                    setTimeout(() => {
                        guideBox.style.borderColor = 'rgba(255,255,255,0.7)';
                        guideBox.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.5)';
                        html5QrCode.resume();
                    }, 1500);
                } else {
                    showNotification("Scanned", `${s.name} marked.`);
                    setTimeout(() => html5QrCode.resume(), 1500);
                }
            } else {
                setTimeout(() => html5QrCode.resume(), 1000);
            }
        }

        async function saveBulkAttendance() {
            const dateStr = document.getElementById('att-date').value;
            const cls = document.getElementById('att-class-select').value;
            const checkboxes = Array.from(document.querySelectorAll('.att-row input[type="checkbox"]:not(:disabled)'));
            if (checkboxes.length === 0) { showNotification("Info", "No new changes.", true); return; }
            const newRecords = checkboxes.map(cb => {
                const row = cb.closest('tr');
                return { student_id: row.getAttribute('data-id'), class_name: cls, date: dateStr, status: cb.checked ? 'Present' : 'Absent', marked_by: currentUser.user_id };
            });
            const { error } = await supabaseClient.from('attendance').insert(newRecords);
            if (error) showNotification("Error", "Save failed.", true); else { showNotification("Success", "Saved."); loadAttendance(); }
        }

        // --- UTILS ---
        function getFreshButton() {
            const oldBtn = document.getElementById('alert-ok-btn');
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn);
            return newBtn;
        }

        function showNotification(t, m, e = false) {
            const md = document.getElementById('custom-alert');
            document.getElementById('alert-title').innerText = t;
            document.getElementById('alert-message').innerText = m;
            document.getElementById('alert-cancel-btn').classList.add('hidden');
            const btn = getFreshButton();
            btn.innerText = "Acknowledge";
            btn.onclick = closeAlert;
            document.getElementById('alert-icon').setAttribute('data-lucide', e ? 'x-circle' : 'check-circle');
            document.getElementById('alert-icon-bg').className = e ? 'w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-600 shadow-inner' : 'w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-6 text-teal-700 shadow-inner';
            lucide.createIcons();
            md.classList.remove('pointer-events-none', 'opacity-0');
            md.querySelector('div.transform').classList.replace('scale-95', 'scale-100');
        }

        function showConfirm(t, m, cb) {
            const md = document.getElementById('custom-alert');
            document.getElementById('alert-title').innerText = t;
            document.getElementById('alert-message').innerText = m;
            document.getElementById('alert-cancel-btn').classList.remove('hidden');
            const btn = getFreshButton();
            btn.innerText = "Yes, Proceed";
            btn.onclick = () => { closeAlert(); cb(); };
            document.getElementById('alert-icon').setAttribute('data-lucide', 'alert-circle');
            document.getElementById('alert-icon-bg').className = 'w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6 text-amber-600 shadow-inner';
            lucide.createIcons();
            md.classList.remove('pointer-events-none', 'opacity-0');
            md.querySelector('div.transform').classList.replace('scale-95', 'scale-100');
        }

        function closeAlert() {
            const md = document.getElementById('custom-alert');
            md.classList.add('opacity-0');
            md.querySelector('div.transform').classList.replace('scale-100', 'scale-95');
            setTimeout(() => md.classList.add('pointer-events-none'), 300);
        }

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden-view'));
            document.getElementById('view-' + v).classList.remove('hidden-view');
            document.querySelectorAll('nav button').forEach(b => { b.classList.remove('active-nav'); b.classList.add('hover:bg-slate-800'); });
            const b = document.getElementById('nav-' + v);
            if (b) { b.classList.add('active-nav'); b.classList.remove('hover:bg-slate-800'); }
            if (window.innerWidth < 768) { const s = document.getElementById('sidebar'); if (!s.classList.contains('-translate-x-full')) toggleSidebar(); }
            if (v === 'attendance') loadAttendance();
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar');
            const o = document.getElementById('mobile-overlay');
            if (s.classList.contains('-translate-x-full')) {
                s.classList.remove('-translate-x-full');
                o.classList.remove('hidden');
                setTimeout(() => o.classList.add('opacity-100'), 10);
            } else {
                s.classList.add('-translate-x-full');
                o.classList.remove('opacity-100');
                setTimeout(() => o.classList.add('hidden'), 300);
            }
        }

        function printDailyRegister() {
            const cls = document.getElementById('att-class-select').value;
            const dateStr = document.getElementById('att-date').value;
            const rows = Array.from(document.querySelectorAll('.att-row')).map((tr, index) => {
                const name = tr.querySelector('td:first-child').innerText;
                const status = tr.querySelector('.status-label').innerText;
                return `<tr><td style="border:1px solid #000;padding:5px">${index+1}</td><td style="border:1px solid #000;padding:5px">${name}</td><td style="border:1px solid #000;padding:5px">${status}</td></tr>`;
            }).join('');
            const win = window.open('','_blank');
            win.document.write(`<h3>Attendance: ${cls} (${dateStr})</h3><table style="width:100%;border-collapse:collapse">${rows}</table><script>window.print()<\/script>`);
        }

        function handleLogout() {
            showConfirm("Log Out?", "End your session?", async () => {
                await supabaseClient.auth.signOut();
                location.reload();
            });
        }
    </script>
</body>

</html>
